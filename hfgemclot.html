<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Blood Coagulation Cascade</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use a reliable, versioned CDN for Lucide -->
    <script src="https://unpkg.com/lucide@0.263.1/dist/umd/lucide.min.js"></script>
    <style>
        /* Custom Animations */
        @keyframes flow {
            0% { stroke-dashoffset: 20; }
            100% { stroke-dashoffset: 0; }
        }

        .flowing-path {
            stroke-dasharray: 5;
            animation: flow 1s linear infinite;
        }

        .blocked-path {
            stroke: #ef4444; /* Red */
            stroke-dasharray: 5;
            opacity: 0.5;
        }

        .node-pulse {
            animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }

        @keyframes pulse-ring {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        .factor-node {
            transition: all 0.3s ease;
        }
        
        .factor-node:hover {
            transform: scale(1.1);
            z-index: 20;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 p-4 shadow-sm z-10 flex justify-between items-center shrink-0">
        <div class="flex items-center gap-2">
            <div class="p-2 bg-red-100 rounded-lg">
                <span id="header-icon">ü©∏</span>
            </div>
            <div>
                <h1 class="text-xl font-bold text-slate-800">Coagulation Cascade Simulator</h1>
                <div class="flex flex-col">
                    <p class="text-xs text-slate-500 hidden sm:block">Interactive Pharmacodynamics Tool</p>
                    <p class="text-[10px] text-slate-400 font-medium uppercase tracking-wider">Hafeez Faridi Ph.D.</p>
                </div>
            </div>
        </div>
        <button onclick="resetSimulation()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-sm transition">
             Reset
        </button>
    </header>

    <!-- Main Layout -->
    <main class="flex-1 flex flex-col lg:flex-row overflow-hidden relative">
        
        <!-- Left: Interactive Diagram -->
        <div class="flex-1 relative bg-slate-50 overflow-hidden" id="diagram-container">
            <!-- Background Grid -->
            <div class="absolute inset-0 opacity-5" style="background-image: radial-gradient(#64748b 1px, transparent 1px); background-size: 20px 20px;"></div>

            <!-- Labels for Pathways -->
            <div class="absolute top-4 left-4 text-xs font-bold tracking-wider text-blue-600 uppercase bg-blue-50 px-2 py-1 rounded border border-blue-100">Intrinsic Pathway</div>
            <div class="absolute top-4 right-4 text-xs font-bold tracking-wider text-teal-600 uppercase bg-teal-50 px-2 py-1 rounded border border-teal-100">Extrinsic Pathway</div>
            <div class="absolute bottom-1/3 left-1/2 -translate-x-1/2 text-xs font-bold tracking-wider text-purple-600 uppercase bg-purple-50 px-2 py-1 rounded border border-purple-100">Common Pathway</div>

            <!-- SVG Layer for connections -->
            <svg id="connections-layer" class="absolute inset-0 w-full h-full pointer-events-none z-0"></svg>

            <!-- Nodes Layer (Generated by JS) -->
            <div id="nodes-layer" class="absolute inset-0 w-full h-full z-10 pointer-events-none">
                <!-- Nodes will be injected here -->
            </div>

            <!-- Animation Status Overlay -->
            <div id="status-overlay" class="absolute bottom-4 left-4 right-4 bg-white/90 backdrop-blur p-3 rounded-lg border border-slate-200 shadow-lg text-sm text-center transform transition-transform duration-300 translate-y-20 opacity-0 lg:w-auto lg:left-1/2 lg:-translate-x-1/2">
                <span id="status-text" class="font-medium text-slate-700">System Ready</span>
            </div>
        </div>

        <!-- Right: Controls & Info -->
        <aside class="w-full lg:w-96 bg-white border-l border-slate-200 flex flex-col h-[40vh] lg:h-auto shadow-xl z-20">
            
            <!-- Tabs -->
            <div class="flex border-b border-slate-200">
                <button onclick="switchTab('drugs')" id="tab-btn-drugs" class="flex-1 py-3 text-sm font-medium border-b-2 border-blue-500 text-blue-600 bg-blue-50">Treatments</button>
                <button onclick="switchTab('info')" id="tab-btn-info" class="flex-1 py-3 text-sm font-medium border-b-2 border-transparent text-slate-500 hover:text-slate-700">Factor Info</button>
            </div>

            <!-- Content Area -->
            <div class="flex-1 overflow-y-auto p-6 relative">
                
                <!-- Drug Selection Panel -->
                <div id="panel-drugs" class="space-y-6">
                    <div>
                        <h3 class="text-sm font-bold text-slate-900 mb-3 flex items-center gap-2">
                            üíä Select Medication
                        </h3>
                        <div class="grid grid-cols-1 gap-2">
                            <button onclick="applyDrug('none')" id="btn-none" class="drug-btn active w-full text-left px-4 py-3 rounded-lg border border-blue-500 bg-blue-50 text-blue-700 text-sm font-medium transition">
                                No Medication (Normal Hemostasis)
                            </button>
                            <button onclick="applyDrug('warfarin')" id="btn-warfarin" class="drug-btn w-full text-left px-4 py-3 rounded-lg border border-slate-200 hover:bg-slate-50 text-slate-700 text-sm font-medium transition group">
                                <div class="flex justify-between items-center">
                                    <span>Warfarin (Coumadin)</span>
                                    <span class="text-xs bg-orange-100 text-orange-700 px-2 py-0.5 rounded">Vit K Antagonist</span>
                                </div>
                                <div class="text-xs text-slate-500 mt-1 font-normal opacity-0 group-hover:opacity-100 h-0 group-hover:h-auto overflow-hidden transition-all">Inhibits factors II, VII, IX, X</div>
                            </button>
                            <button onclick="applyDrug('heparin')" id="btn-heparin" class="drug-btn w-full text-left px-4 py-3 rounded-lg border border-slate-200 hover:bg-slate-50 text-slate-700 text-sm font-medium transition group">
                                <div class="flex justify-between items-center">
                                    <span>Unfractionated Heparin</span>
                                    <span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded">Indirect Thrombin Inh.</span>
                                </div>
                                <div class="text-xs text-slate-500 mt-1 font-normal opacity-0 group-hover:opacity-100 h-0 group-hover:h-auto overflow-hidden transition-all">Potentiates Antithrombin III</div>
                            </button>
                            <button onclick="applyDrug('rivaroxaban')" id="btn-rivaroxaban" class="drug-btn w-full text-left px-4 py-3 rounded-lg border border-slate-200 hover:bg-slate-50 text-slate-700 text-sm font-medium transition group">
                                <div class="flex justify-between items-center">
                                    <span>Rivaroxaban (Xarelto)</span>
                                    <span class="text-xs bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded">Direct Xa Inhibitor</span>
                                </div>
                            </button>
                            <button onclick="applyDrug('dabigatran')" id="btn-dabigatran" class="drug-btn w-full text-left px-4 py-3 rounded-lg border border-slate-200 hover:bg-slate-50 text-slate-700 text-sm font-medium transition group">
                                <div class="flex justify-between items-center">
                                    <span>Dabigatran (Pradaxa)</span>
                                    <span class="text-xs bg-pink-100 text-pink-700 px-2 py-0.5 rounded">Direct Thrombin Inh.</span>
                                </div>
                            </button>
                        </div>
                    </div>

                    <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
                        <h4 class="text-xs font-bold text-amber-800 uppercase tracking-wide mb-2">Simulation Status</h4>
                        <div class="flex items-center gap-3">
                            <button onclick="startSimulation()" id="sim-btn" class="flex-1 bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-md text-sm font-bold shadow-sm transition flex items-center justify-center gap-2">
                                Start Clotting
                            </button>
                        </div>
                        <p id="sim-outcome" class="mt-3 text-xs text-amber-900 hidden"></p>
                    </div>
                </div>

                <!-- Info Panel -->
                <div id="panel-info" class="hidden h-full flex flex-col">
                    <div id="info-content" class="text-slate-600 text-sm leading-relaxed">
                        <div class="flex flex-col items-center justify-center h-48 text-center text-slate-400">
                            <p>Select a Factor node on the diagram<br>to view detailed information.</p>
                        </div>
                    </div>
                </div>

            </div>
        </aside>

    </main>

    <script>
        // --- Data Definitions ---
        const factors = [
            { id: 'XII', name: 'Factor XII', label: 'XII', sub: 'Hageman', x: 20, y: 15, type: 'intrinsic', desc: "Initiates the intrinsic pathway when it contacts a negatively charged surface (like collagen)." },
            { id: 'XI', name: 'Factor XI', label: 'XI', sub: 'Plasma Thromboplastin', x: 20, y: 30, type: 'intrinsic', desc: "Activated by Factor XIIa. It activates Factor IX." },
            { id: 'IX', name: 'Factor IX', label: 'IX', sub: 'Christmas', x: 20, y: 45, type: 'intrinsic', desc: "Activated by XIa. Works with Factor VIII to activate Factor X. Vitamin K dependent." },
            { id: 'VIII', name: 'Factor VIII', label: 'VIII', sub: 'Anti-hemophilic', x: 30, y: 45, type: 'intrinsic', desc: "A cofactor for Factor IXa. Deficiency causes Hemophilia A." },
            { id: 'TF', name: 'Tissue Factor', label: 'TF', sub: 'III', x: 80, y: 15, type: 'extrinsic', desc: "Released from damaged tissue. Initiates the extrinsic pathway." },
            { id: 'VII', name: 'Factor VII', label: 'VII', sub: 'Stable', x: 80, y: 30, type: 'extrinsic', desc: "Binds with Tissue Factor to activate Factor X. Vitamin K dependent." },
            { id: 'X', name: 'Factor X', label: 'X', sub: 'Stuart-Prower', x: 50, y: 60, type: 'common', desc: "Convergence point. Vitamin K dependent." },
            { id: 'V', name: 'Factor V', label: 'V', sub: 'Labile', x: 60, y: 60, type: 'common', desc: "A cofactor for Factor Xa." },
            { id: 'II', name: 'Factor II', label: 'II', sub: 'Prothrombin', x: 50, y: 75, type: 'common', desc: "Converted to Thrombin (IIa). Vitamin K dependent." },
            { id: 'I', name: 'Factor I', label: 'I', sub: 'Fibrinogen', x: 50, y: 90, type: 'common', desc: "Converted by Thrombin into insoluble Fibrin." },
            { id: 'Clot', name: 'Fibrin Clot', label: 'Clot', sub: '', x: 50, y: 97, type: 'result', desc: "The final mesh that stops bleeding." }
        ];

        const connections = [
            { from: 'XII', to: 'XI' }, { from: 'XI', to: 'IX' }, { from: 'IX', to: 'X' },
            { from: 'VIII', to: 'X', dashed: true }, { from: 'TF', to: 'VII' },
            { from: 'VII', to: 'X' }, { from: 'X', to: 'II' }, { from: 'V', to: 'II', dashed: true },
            { from: 'II', to: 'I' }, { from: 'I', to: 'Clot' }
        ];

        const drugs = {
            'none': { name: 'None', targets: [] },
            'warfarin': { name: 'Warfarin', targets: ['II', 'VII', 'IX', 'X'] },
            'heparin': { name: 'Heparin', targets: ['II', 'X', 'IX', 'XI', 'XII'] },
            'rivaroxaban': { name: 'Rivaroxaban', targets: ['X'] },
            'dabigatran': { name: 'Dabigatran', targets: ['II'] }
        };

        let currentDrug = 'none';
        let isSimulating = false;
        let animationTimeouts = [];

        // --- Core Functions ---

        function updateIcons() {
            if (window.lucide) {
                lucide.createIcons();
            }
        }

        function init() {
            renderNodes();
            renderConnections();
            updateIcons();
            window.addEventListener('resize', renderConnections);
        }

        function renderNodes() {
            const container = document.getElementById('nodes-layer');
            container.innerHTML = '';
            factors.forEach(f => {
                const node = document.createElement('div');
                node.className = `factor-node absolute flex flex-col items-center justify-center cursor-pointer pointer-events-auto`;
                node.style.left = `${f.x}%`;
                node.style.top = `${f.y}%`;
                node.style.transform = 'translate(-50%, -50%)';
                node.id = `node-${f.id}`;
                node.onclick = () => showInfo(f);

                let colorClass = f.type === 'result' ? 'bg-red-500 text-white' : 'bg-white text-slate-700';
                if(f.type === 'intrinsic') colorClass = 'bg-blue-50 border-blue-200 text-blue-800';
                if(f.type === 'extrinsic') colorClass = 'bg-teal-50 border-teal-200 text-teal-800';
                if(f.type === 'common') colorClass = 'bg-purple-50 border-purple-200 text-purple-800';

                node.innerHTML = `
                    <div class="w-16 h-16 rounded-lg border-2 flex flex-col items-center justify-center shadow-md ${colorClass} overflow-hidden relative">
                        <span class="font-bold">${f.label}</span>
                        <div class="drug-block-icon hidden absolute inset-0 bg-black/40 flex items-center justify-center">üö´</div>
                    </div>
                `;
                container.appendChild(node);
            });
        }

        function renderConnections() {
            const svg = document.getElementById('connections-layer');
            svg.innerHTML = '';
            const rect = document.getElementById('diagram-container').getBoundingClientRect();

            connections.forEach((conn, idx) => {
                const f = factors.find(x => x.id === conn.from);
                const t = factors.find(x => x.id === conn.to);
                const x1 = (f.x / 100) * rect.width;
                const y1 = (f.y / 100) * rect.height;
                const x2 = (t.x / 100) * rect.width;
                const y2 = (t.y / 100) * rect.height;

                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                path.setAttribute("d", `M ${x1} ${y1} L ${x2} ${y2}`);
                path.setAttribute("stroke", "#94a3b8");
                path.setAttribute("stroke-width", "2");
                if (conn.dashed) path.setAttribute("stroke-dasharray", "4");
                path.id = `path-${conn.from}-${conn.to}`;
                svg.appendChild(path);
            });
        }

        function switchTab(tab) {
            document.getElementById('panel-drugs').classList.toggle('hidden', tab !== 'drugs');
            document.getElementById('panel-info').classList.toggle('hidden', tab !== 'info');
        }

        function showInfo(f) {
            switchTab('info');
            const affected = drugs[currentDrug].targets.includes(f.id);
            document.getElementById('info-content').innerHTML = `
                <h2 class="text-xl font-bold">${f.name}</h2>
                <p class="text-sm mt-2 text-slate-500">${affected ? '‚ùå INHIBITED' : '‚úÖ ACTIVE'}</p>
                <p class="mt-4 p-3 bg-slate-50 rounded">${f.desc}</p>
            `;
        }

        function applyDrug(key) {
            resetSimulation();
            currentDrug = key;
            document.querySelectorAll('.drug-btn').forEach(b => b.classList.remove('bg-blue-50', 'border-blue-500'));
            document.getElementById(`btn-${key}`).classList.add('bg-blue-50', 'border-blue-500');
            
            factors.forEach(f => {
                const node = document.getElementById(`node-${f.id}`);
                const blocked = drugs[key].targets.includes(f.id);
                node.querySelector('.drug-block-icon').classList.toggle('hidden', !blocked);
            });
        }

        function resetSimulation() {
            animationTimeouts.forEach(clearTimeout);
            animationTimeouts = [];
            isSimulating = false;
            document.querySelectorAll('path').forEach(p => {
                p.classList.remove('flowing-path', 'blocked-path');
                p.setAttribute('stroke', '#94a3b8');
            });
            document.querySelectorAll('.factor-node div').forEach(d => d.classList.remove('node-pulse', 'ring-4', 'ring-blue-400'));
            document.getElementById('status-overlay').classList.add('translate-y-20', 'opacity-0');
            document.getElementById('sim-btn').textContent = 'Start Clotting';
        }

        function startSimulation() {
            if(isSimulating) { resetSimulation(); return; }
            isSimulating = true;
            document.getElementById('sim-btn').textContent = 'Stop';
            const status = document.getElementById('status-overlay');
            status.classList.remove('translate-y-20', 'opacity-0');
            
            const targets = drugs[currentDrug].targets;
            
            // Sequence
            runStep('XII', 'TF', 0);
            propagate('XII', 'XI', 1000);
            propagate('XI', 'IX', 2000);
            propagate('TF', 'VII', 1000);
            
            setTimeout(() => {
                if (!targets.includes('X') && (!targets.includes('IX') || !targets.includes('VII'))) {
                    runStep('X', null, 0);
                    propagate('X', 'II', 1000);
                    setTimeout(() => {
                        if(!targets.includes('II')) {
                            runStep('II', null, 0);
                            propagate('II', 'I', 1000);
                            setTimeout(() => {
                                if(!targets.includes('I')) {
                                    runStep('I', 'Clot', 1000);
                                    document.getElementById('status-text').textContent = "Clot Formed ‚úÖ";
                                } else { fail("Blocked at Fibrin"); }
                            }, 1500);
                        } else { fail("Blocked at Thrombin"); }
                    }, 1500);
                } else { fail("Cascade Blocked"); }
            }, 3000);
        }

        function runStep(id1, id2, delay) {
            setTimeout(() => {
                if(id1) document.getElementById(`node-${id1}`).querySelector('div').classList.add('node-pulse');
                if(id2) document.getElementById(`node-${id2}`).querySelector('div').classList.add('node-pulse');
            }, delay);
        }

        function propagate(from, to, delay) {
            setTimeout(() => {
                const p = document.getElementById(`path-${from}-${to}`);
                if (!drugs[currentDrug].targets.includes(from)) {
                    p.setAttribute('stroke', '#3b82f6');
                    p.classList.add('flowing-path');
                    document.getElementById(`node-${to}`).querySelector('div').classList.add('node-pulse');
                } else {
                    p.setAttribute('stroke', '#ef4444');
                    p.classList.add('blocked-path');
                }
            }, delay);
        }

        function fail(m) { document.getElementById('status-text').textContent = m + " ‚ùå"; }

        window.onload = init;
    </script>
</body>
</html>
